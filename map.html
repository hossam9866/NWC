<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Locations Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ArcGIS CSS -->
  <link
    rel="stylesheet"
    href="https://js.arcgis.com/4.29/esri/themes/light/main.css"
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #viewDiv {
      height: 100%;
      width: 100%;
    }
    #status {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 10;
      background: rgba(0,0,0,.75);
      color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      font-family: Arial, sans-serif;
      font-size: 13px;
      max-width: 360px;
      white-space: pre-wrap;
    }
  </style>

  <!-- ArcGIS JS -->
  <script src="https://js.arcgis.com/4.29/"></script>
</head>

<body>
  <div id="status">Reading locations from URL…</div>
  <div id="viewDiv"></div>

  <script>
    const statusEl = document.getElementById("status");

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    // ============================
    // Read "location" from URL
    // ============================
    function readLocationsFromUrl() {
      const query = location.search || "";
      const match = query.match(/[?&]location=(.*)$/);

      if (!match) return [];

      let raw = match[1];

      // Try normal JSON (already decoded)
      try {
        return JSON.parse(raw);
      } catch (_) {}

      // Try decoded JSON
      try {
        return JSON.parse(decodeURIComponent(raw));
      } catch (_) {}

      return [];
    }

    const locations = readLocationsFromUrl();
    const validLocations = Array.isArray(locations)
      ? locations.filter(l => l && Array.isArray(l.points) && l.points.length >= 3)
      : [];

    setStatus(
      `Locations received: ${Array.isArray(locations) ? locations.length : 0}\nValid polygons: ${validLocations.length}`
    );

    if (!validLocations.length) {
      setStatus(statusEl.textContent + "\n❌ No valid locations.");
      throw new Error("No valid locations");
    }

    // ============================
    // ArcGIS Map
    // ============================
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/Graphic",
      "esri/geometry/Polygon",
      "esri/geometry/Extent"
    ], function (Map, MapView, Graphic, Polygon, Extent) {

      function hexToRgba(hex, opacity = 35) {
        let h = String(hex || "#2f6f9e").replace("#", "");
        if (h.length === 3) h = h[0]+h[0]+h[1]+h[1]+h[2]+h[2];
        const r = parseInt(h.slice(0,2),16);
        const g = parseInt(h.slice(2,4),16);
        const b = parseInt(h.slice(4,6),16);
        const a = Math.max(0, Math.min(1, opacity / 100));
        return `rgba(${r},${g},${b},${a})`;
      }

      const map = new Map({
        basemap: "streets-vector"
      });

      const view = new MapView({
        container: "viewDiv",
        map,
        zoom: 6,
        center: [47, 25]
      });

      view.when(async () => {
        const graphics = [];

        validLocations.forEach((loc, i) => {
          const ring = loc.points.map(p => [Number(p[0]), Number(p[1])]);

          // close polygon
          const f = ring[0], l = ring[ring.length - 1];
          if (f[0] !== l[0] || f[1] !== l[1]) ring.push([f[0], f[1]]);

          const polygon = new Polygon({
            rings: [ring],
            spatialReference: { wkid: 4326 }
          });

          const graphic = new Graphic({
            geometry: polygon,
            symbol: {
              type: "simple-fill",
              color: hexToRgba(loc.fill, loc.opacity),
              outline: {
                color: loc.outline || "#05538c",
                width: 2
              }
            },
            attributes: {
              name: loc.name || `Location ${i+1}`
            }
          });

          graphics.push(graphic);
        });

        view.graphics.addMany(graphics);

        try {
          const extents = graphics.map(g => g.geometry.extent);
          const full = Extent.union(extents);
          await view.goTo(full.expand(1.2));
        } catch (_) {}

        setStatus(statusEl.textContent + "\n✅ Map rendered.");
      });
    });
  </script>
</body>
</html>
